echo "ğŸ” Executando TODAS as verificaÃ§Ãµes de qualidade antes do commit..."
echo "================================================"

# FunÃ§Ã£o para tentar corrigir automaticamente
try_auto_fix() {
    local error_type="$1"
    local fix_command="$2"
    local description="$3"

    echo ""
    echo "âŒ Erro encontrado: $error_type"
    echo "ğŸ’¡ $description"
    echo ""
    echo "ğŸ”„ Tentando correÃ§Ã£o automÃ¡tica..."

    if eval "$fix_command"; then
        echo "âœ… CorreÃ§Ã£o aplicada com sucesso!"
        return 0
    else
        echo "âŒ Falha na correÃ§Ã£o automÃ¡tica"
        echo "ğŸ’¡ Execute manualmente: $fix_command"
        return 1
    fi
}

# 1. VerificaÃ§Ã£o de ortografia
echo "ğŸ“ 1/6 Verificando ortografia (Peck)..."
if ! composer run test:typos; then
    if try_auto_fix "Ortografia" "composer run test:typos" "VerificaÃ§Ã£o de ortografia falhou"; then
        echo "âœ… Ortografia corrigida automaticamente"
    else
        echo "âŒ Erro na verificaÃ§Ã£o de ortografia!"
        echo "ğŸ’¡ Execute: composer run test:typos"
        exit 1
    fi
fi
echo "âœ… Ortografia OK"
echo ""
echo ""
# 2. VerificaÃ§Ã£o de tipos
echo "ğŸ” 2/6 Verificando tipos (Larastan)..."
if ! composer run test:types; then
    if try_auto_fix "Tipos" "composer run test:types" "VerificaÃ§Ã£o de tipos falhou"; then
        echo "âœ… Tipos corrigidos automaticamente"
    else
        echo "âŒ Erro na verificaÃ§Ã£o de tipos!"
        echo "ğŸ’¡ Execute: composer run test:types"
        exit 1
    fi
fi
echo "âœ… Tipos OK"
echo ""
echo ""
# 3. VerificaÃ§Ã£o de formataÃ§Ã£o
echo "ğŸ¨ 3/6 Verificando formataÃ§Ã£o (Pint + Prettier)..."
if ! composer run test:lint; then
    if try_auto_fix "FormataÃ§Ã£o" "composer run lint" "VerificaÃ§Ã£o de formataÃ§Ã£o falhou"; then
        echo "âœ… FormataÃ§Ã£o corrigida automaticamente"
    else
        echo "âŒ Erro na verificaÃ§Ã£o de formataÃ§Ã£o!"
        echo "ğŸ’¡ Execute: composer run lint"
        exit 1
    fi
fi
echo "âœ… FormataÃ§Ã£o OK"
echo ""
echo ""
# 4. VerificaÃ§Ã£o de cobertura de tipos
echo "ğŸ“Š 4/6 Verificando cobertura de tipos..."
if ! composer run test:type-coverage; then
    if try_auto_fix "Cobertura de tipos" "composer run test:type-coverage" "VerificaÃ§Ã£o de cobertura de tipos falhou"; then
        echo "âœ… Cobertura de tipos corrigida automaticamente"
    else
        echo "âŒ Erro na verificaÃ§Ã£o de cobertura de tipos!"
        echo "ğŸ’¡ Execute: composer run test:type-coverage"
        exit 1
    fi
fi
echo "âœ… Cobertura de tipos OK"
echo ""
echo ""

# 5. Testes unitÃ¡rios
echo "ğŸ§ª 5/6 Executando testes unitÃ¡rios (Pest)..."
if ! composer run test:unit; then
    if try_auto_fix "Testes unitÃ¡rios" "composer run test:unit" "Testes unitÃ¡rios falharam"; then
        echo "âœ… Testes unitÃ¡rios corrigidos automaticamente"
    else
        echo "âŒ Erro nos testes unitÃ¡rios!"
        echo "ğŸ’¡ Execute: composer run test:unit"
        exit 1
    fi
fi
echo "âœ… Testes unitÃ¡rios OK"
echo ""
echo ""

# 6. VerificaÃ§Ã£o de refatoraÃ§Ã£o
echo "ğŸ”„ 6/6 Verificando refatoraÃ§Ã£o (Rector)..."
if ! composer run test:refactor; then
    if try_auto_fix "RefatoraÃ§Ã£o" "composer run refactor" "VerificaÃ§Ã£o de refatoraÃ§Ã£o falhou"; then
        echo "âœ… RefatoraÃ§Ã£o corrigida automaticamente"
    else
        echo "âŒ Erro na verificaÃ§Ã£o de refatoraÃ§Ã£o!"
        echo "ğŸ’¡ Execute: composer run refactor"
        exit 1
    fi
fi
echo "âœ… RefatoraÃ§Ã£o OK"
echo ""
echo ""

echo "================================================"
echo "ğŸ‰ TODAS as verificaÃ§Ãµes passaram! Commit permitido."
echo "âœ¨ Seu cÃ³digo estÃ¡ com qualidade mÃ¡xima!"
echo ""
echo ""
echo ""
